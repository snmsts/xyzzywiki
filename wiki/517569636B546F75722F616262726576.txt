#freeze
#contents

*abbrevとdabbrev〜文字を補完〜 [#f6d21c79]

**前口上 [#u3660a22]

今回は長い文字列や、固有名詞の入力をサポートするabbrevとdabbrevを紹介します。今回紹介するabbrevとdabbrevは、Windows上で動作するエディタで持っているものは少ないと思います。とりわけdabbrevは珍しくて、面白い機能です。（自分はあんまり使いこなしていないんですが）

ではいつものように、本題に入る前にキーバインドの話を。''C-c C-r''と入力すると、単語登録のウィンドウが表示されます。xyzzy上で文字列を選択している時には、その文字列が自動的に語句（G）の部分に入ってくれます。

#br
#br

CENTER:''C-c C-rで単語登録のダイアログが表示''
CENTER:#ref(01.png,center,100%)
CENTER:#img(,clear)
CENTER:&size(10){いろいろと登録しておくと便利だと思います。};

#br
#br

単語登録は、使わない人は使わないのかも知れませんが、自分は結構使っています。いろいろ登録しておくと便利です。

**abbrevの説明から [#t6613606]

それでは本題に入ります。まずabbrevを先に説明します。実は、abbrevの説明は[[赤塚さんのページ>http://www.jsdlab.co.jp/~kei/xyzzy/xyzzy_abbrev.html]]にて、既に説明がされています。書いてる当人も[[赤塚さんのページ>http://www.jsdlab.co.jp/~kei/xyzzy/xyzzy_abbrev.html]]で初めてabbrevを知りました :p非常に分かりやすい説明なので、そっちを見てもらったほうが早いです。ぜひ参照してください。

と言う訳で、[[赤塚さんのページ>http://www.jsdlab.co.jp/~kei/xyzzy/xyzzy_abbrev.html]]を参照した事を前提に話をします。[[赤塚さんのページ>http://www.jsdlab.co.jp/~kei/xyzzy/xyzzy_abbrev.html]]を見てもらえばわかる通り、abbrevの特徴は以下の通りです。

- abbrevはマイナーモードの一種
- 一言で説明すると、ある文字列を別の文字列に変換する機能((「略語展開機能」等とも呼ばれるらしい))
- 変換するには、.abbrev_defsという変換するための定義ファイルが必要((無かったら初回起動時に作成))
- .abbrev_defsには、メジャーモード毎に何をどのように変換するのかが記述されている
- より具体的には、"変換前"  数字  "変換後"のような、変換テーブルっぽいもの
- なぜ数字があるのかは不明らしい((おそらく変換数をカウントしておけば、Lispで自分好みにカスタマイズ時に便利？))

おそらくabbrevは、フォーマットが決められている文章（htmlとか、プログラミング言語）のときに使うと、より便利なのだと思います。面白いのは、単語の頭文字とか、長さとかに制限がない所ですね。aと入力したら今日は36℃とかって入力するようにすることも出来ます。また、改行をまたいで登録することも出来ます。

先頭のキーバインドの所で紹介した、単語辞書の登録と似ている雰囲気を持っているように思います。（と言うか、単語登録と機能としてはほとんど変わらないのかな？）ただ単語登録と異なるのは、モード毎に同じキーバインドでも異なる文字列を入力可能な所ですね。つまり、全く同じ文字列を略称として登録しても、(モードを切り替えれば)別の文字列を入力できるから、後述するキーマクロ等の時に、使いまわしが利くのかも……。IMEの単語登録の場合、同じ読みでいろいろ登録すると、候補がどんどん増えて面倒なことになりますから、abbrevの方が便利ですね。 ((まぁ、xyzzy以外のソフトでも短縮入力をしたいならば、単語登録以外は無いと思うけど、xyzzyでのみ編集するファイルとかだったら、.abbrev_defsvにいろいろ書いておくと便利ですね。))

**dabbrevとはどんなの？それって美味しいの？ [#u8abe064]

***それってなによ？ [#ta16cd40]

dabbrevというのは、dynamic abbrevの略で、abbrevみたいに定義ファイルを用意せずとも補完が出来るようになる機能です。マイナーモードでもなく、特に何も指定せずに使用できます。標準のキーバインドでは、C-x /で使用する事が出来ます。

使い方は簡単です。試しに、scratchバッファに

 xyzzy
 xyzzy

とか、何でも良いので文字を打ってみてください。その後、同じ単語を入力する時に、少し楽をする事が出来ます。上の例では、新たに改行して、

 xy

まで入力した後に、上記の C-x /とすると、xyの文字列がxyzzyに変化します。これがdabbrevです。

また、 C-x /の代わりに、C-x \とすると、（IMEの候補のように）ポップアップウィンドウの形式で候補を表示してくれます。
***何が補完の対象となるの？ [#o366cfd1]

自分もあんまりよく調べていないのでおそらくですけど、少なくとも何もxyzzyを変更していない状態であれば、xyzzyが開いているファイル全てがdabbrevの補完候補の対象となるようです。

つまり、違うファイルの内容をまたいで補完をしてくれます。例えば、xyzzyがa.txtと、b.txtの二つを開いていて、それぞれのファイルに

 aaaaa

と、

 bbbbb

が書かれていた時に、b.txtのウィンドウでaと打ち込んだ後で、C-x /とすれば、（a.txtに書かれている内容のaaaaaとマッチして）''aaaaa''となってくれます。

***自分が補完してもらいたい文字列と違っているんだけど。その1 [#gd1c1a18]

例えば、xyzzyの他に、xyzzyaaaとかって文字列があった時には、自分の思った通りの結果が得られない事があります。その原因の一つは、補完する文字列が一つに決まらない時です。そんな時には、もう一度 C-x /を入力すると次の候補を表示してくれます。まだ自分の思った文字列が出ない時には、どんどんC-x /を入力すればOKです。

***自分が補完してもらいたい文字列と違っているんだけど。その2 [#j33eaab1]

もう一つの原因は、補完してもらいたい文字列が複数の単語であるからかもしれないです。

dabbrevは単語単位で補完をするみたいなので、例えば、

 今日は花火大会

という文章があった時に、同じファイル内で、再び今日はまでを入力して、C-x /で補完してほしいと思っても、補完してくれません。((''今日''まででC-x /を入力すれば''今日は''にはなりますけど))つまり、単語をまたいで補完をしてくれないようです。したがって、もし 花火大会を補完したい時には、単語の始めの数文字（例えば花）を入力した後に、C-x /とすれば出来ます。

ちなみに言い忘れましたが、日本語も補完対象に含まれています。((日本語が補完されるのって、あんまり見たことないので新鮮でした。))手っ取り早く単語の境界を見分けるには、M-fやM-b(=Altキーを押しながらf、あるいはbを押す）を使うのが楽です。

***自分が補完してもらいたい文字列と違っているんだけど……。その3 [#b05bcdb4]

上記と同じ理由で、補完してもらいたい時にキャレットが単語の境界にある場合には補完が行われません。だいたい補完が上手く出来ない場合には、単語境界が問題となっている事が多いように思います。

***ちょっとだけカスタマイズしてみる [#q36da09b]

実に主観的かもしれませんが、キーバインドをもっと楽なキーに変更すると便利です。下のは、実は自分が設定しているものそのままですが……。

カスタマイズの仕方はいつもと同じで、.xyzzyかsiteinit.lに書いておくことで出来ます。例えば、

 (require "dabbrev")
 (global-set-key #\C-t 'dabbrev-popup)
 (setq *popup-completion-list-default* :always)

と書いてみました。1行目はあんまり気にせずに……。((わからないからだけど))2行目はキーバインドを設定しています。この場合C-tで補完が行えます。さらに、その右に書かれているdabbrev-popupと言うのは、dabbrevをIMEの候補のようにポップアップで表示するようにするものです。3行目もよく分かりません。これもあまり気にしないことにします。((もっと細かく指定することも出来ると思います。))

上記のように設定すると、下のように補完がされるようになります。IMEライクの方が、C-nやC-pで候補を選択出来るようになるので楽だと思います。

#br
#br

CENTER:''IMEっぽく候補を表示してみる''
CENTER:#ref(02.png,center,50%)
CENTER:#img(,clear)
CENTER:&size(10){本当はキャレットは表示されません。(''示''の所は反転して表示されてますが、どこでdabbrevをしたのかをわかりやすくするために画像を加工してあります。）};

#br
#br

dabbrevの候補を選択せずに終わらせたいのならば、''Esc''、あるいは''C-[''を押せばOKです。((C-fなどでも大丈夫だったりする。))

**まだまだあると思うけど……これで終了。 [#d0ef3c4b]

まだまだあると思うけど、これ以上はよく分からないので説明はおしまい。次はキーボードマクロですね。書いていて何だけど、自分はこの機能をほとんど使ったことがありません。
