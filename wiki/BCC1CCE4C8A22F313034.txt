* 日本語入力時に『』「」＜＞などの括弧記号をキーバインド操作で出し、かつ、カーソルが括弧の真ん中にくるようにしたい（初歩的質問ですが） [#z43945f0]
-ページ: [[質問箱]]
-投稿者: [[Miteba]]
-状態: 完了
-投稿日: 2005-08-11 14:09:12 (木)

** メッセージ [#f547c559]
初歩的質問ですが……：日本語入力時に『』「」＜＞などの括弧記号をキーバインド操作で出し、かつ、カーソルが括弧の真ん中にくるようにしたいのです。今まで、QXEdiotrを使っていて、括弧入力のマクロをつくってキーバンド定義するというやり方だったのですが、xyzzyでも当然できると思うし、たぶんそういう需要があるので出来合いのマクロ的なものがあるのだと考えるのですが……。『入門xyzzy』をいろいろめくってみたのですが、こうしたことをどうやれがいいかについて、該当箇所がみあたりません。たぶん、commomLisp系xyzzy　Lispで括弧入力用のコードを書いて、site-lisp内にいれておくのでしょうか？
----
-あぁもうなんというか、なんと出し惜しみをしたくなるような質問なんだろう。 -- [[佐野]] &new{2005-08-11 15:37:39 (木)};

 (defvar *insert-paren-list* '("””"
 			      "「」"
 			      "『』"
 			      "〈〉"))
 
 (defun toggle-paren ()
   (interactive)
   (let ((str (buffer-substring (1- (point)) (1+ (point))))) ;;前後の一文字ずつを取ってくる
     (do ((i *insert-paren-list* (cdr i)));;ループをまわす
 	((or
 	  (and (null i) (insert (car *insert-paren-list*)));;最後(i=nil)になったらリストの最初の要素を挿入
 	  (and (equal (car i) str);;なんか見つかったら
 	       (delete-region (1- (point)) (1+ (point)));;前後の一文字ずつを削る
 	       (insert (if (cdr i);;見つかったのの次が何も有るか？
 			   (cadr i);;有ったら次の
 			 (car *insert-paren-list*)));;無かったら最初のをinsert
 	       )))))
   (backward-char));;一文字戻したいよね？
-さすがに使い方は調べてください。 -- [[佐野]] &new{2005-08-11 15:38:26 (木)};

入門xyzzy p.301 「Aa.3 タグの挿入」の簡単な応用だと思うのですが。
 ; そのままだとカーソルが前に進む
 (defun insert-kakko-sample1 ()
   (interactive)
   (insert "「」"))
 
 ; save-excursion を使うと移動しない
 (defun insert-kakko-sample2 ()
   (interactive)
   (save-excursion
     (insert "「」")))

カーソルの位置が真ん中にしたいということで考えて、組み合わせることを思いついたとします。
 ; "「" は前に進む
 (defun insert-kakko-sample3-a ()
   (interactive)
   (insert "「"))
 ; "」" はそのままの位置
 (defun insert-kakko-sample3-b ()
   (interactive)
   (save-excursion
     (insert "」")))
 ; これらを組み合わせる。
 (defun insert-kakko-sample3 ()
   (interactive)
   (insert-kakko-sample3-a)
   (insert-kakko-sample3-b))
この程度、簡単な応用じゃありませんかね。

 ; 清書すると
 (defun insert-kakko-sample4 ()
   (interactive)
   (insert "「")
   (save-excursion
     (insert "」")))

もしかすると"「」" を挿入して一文字戻るというのを先に思いつくかもしれませんね。入門xyzzyの同じところにカーソルを移動する関数の説明がありますから、以下も簡単な応用ですよね。
 ; "「」" を挿入して一文字戻ると考えて
 (defun insert-kakko-sample5 ()
   (interactive)
   (insert "「」")
   (backward-char))
どちらかを思いつけばいいのですから難しいことじゃないと思うのですけど。

で、あとは括弧の種類の分だけ関数を書けば解決です。

また、この程度Lispを書くまでも無くキーボードマクロで解決しますよね。xyzzyのキーボードマクロはキーバインドを割り当てることができます。[[qanda:キーボードマクロで登録したキー操作にキーを割り当てて使えませんか？]]を参照。

さらに言うと、こういうことができる拡張Lispも存在します。[[ShortInput>http://www3.ocn.ne.jp/~han/xyzzy/shortinput.lzh]]です。デフォルトの設定には無いので、説明じっくり読む必要がありますが、そんなに難しいことは書いてないと思います。

自分が短時間で思いつけたり、探せたりするのは経験があるからですけど、初心者という自覚があるんでしたら、一週間でも一ヶ月でも調べるなり試行錯誤するなり考えるなりしていいんじゃないですか。こんなのすぐに必要って物ではないでしょう。 -- NANRI
-どうもありがとうございました。（１）佐野さん共著『入門xyzzy』のpp.301-302にたしかに、記述例でちょっと応用をきかせればよいものがありました。現在まで、xyzzyの知識をpart-timeで断片的アドホックに取得試行していて、MS Office One Noteへのメモはすでに161枚に達したのですが、まだ基本的なところが抜けていて、皆さんをげんなさせがちで申し訳ありません。それでも、丁寧に答えてくださって、感謝しています。今回、初歩的質問でしたが、一をきいて３を知るくらいにxyzzyの他の範囲のことにも理解がましました。　（２）shortinputは導入後うまく機能しましたが、現在使っているQTXCIP（QxEditor系のクリップで、さまざまな記号入力群をあらかじめテキストファイル一覧に書いておけば編集中テキストにコピー出力できる――xyzzy日本語入力にも適用可能）のほうが、popped-upからマウスを流すだけで選べるのでもっと効率がよい気がしました。もっと便利なように自分用になかみを改造してみるつもりです。もともとQXeditorで洋書部分訳などをする必要があり、原文単語にカーソルをあてるだけで辞書引き機能が便利と思っていました(プログラムはだいぶ前にやや複雑な統計分析モデル作成でやっただけで適性がないと自覚してやめ、現在は、文化系的な仕事の目的だけで使用)。xyzzyはもっと多言語でたくさんの辞書が串刺し検索できるらしいことをきき、それが動機でxyzzyを最近使うようになり、QXEditorのような使い勝手の良さまでcustomizeしたい、と思っています。それで、これから日本語入力機能、翻訳補助操作機能をxyzzyでなんとか構築したいというのが希望です。
　（３）一番最初の佐野さん記述のコードを、kakkomacro.lでsite-lispのなかにほうりこんで、.xyzzyで
 (require "kakkomacro"）
 (global-set-key '(#\C-k #\1 #\1) 'toggle-paren)
としたところ、「名前が衝突するため、exportできません: editor::toggle-paren」 とエラー表示されました。なぜか、paren.l　と競合しているようで、paren.lをrequireするのを.xyzzyで無効にすると、エラー表示が消えます。-- [[Miteba]] &new{2005-08-12 12:22:20 (金)};
-上記（３）の理由わかりました。site-lispディレクトリー内のparen.lをみると、129行目に、
 (defun toggle-paren ()
と書いてありました。それで、「名前が衝突するため、exportできません: editor::toggle-paren」とエラー表示がでたのでした。ここを単純に、
 (defun toggle-paren1 ()
とでもかえれば、トグルでカーソル位置に出力するのもうまくいくことを確認しました。なお、QXEditor使用時には、ファンクションキーのひとつに括弧１０種を真ん中にはさむマクロをポップアップメニューで出すようにカスタマイズしていましたが、『入門xyzzy』のメニューを作成する、ポップアップメニューpp.374-375 などを応用して組み合わせればできるのだと思い、やってみるつもりです。&br;&br; P.S.余談になってしまうのですが、、『入門xyzzy』Aa.3タグの挿入 (p.301) をそのまま丸写しして.xyzzyに書き加えて起動しなおしたところ、「104 アクセスできないシンボルです: c:/Home/howm1」というエラー表示が出てしまいました。paren.lでの括弧点検では、書き足した　Aa.3での括弧数に関してまちがいはありませんし、うまくいった他のAa.1 Aa.2 のlispをコピーしてから直していったのでミスはないはずなのですが……。Aa.3は、.xyzzyの47-53行目であり、それがhowメモ・ファイル群切り替えのキーバインドの途中文104行に飛んでエラー表示をもたらす、とは不思議なのですが、このように各lisp文単位はそれ自体で正しくとも、他の単位とかみ合わせが悪くなるということもあるのでしょうか？ -- [[Miteba]] &new{2005-08-12 20:39:45 (金)};
-各lisp文単位はそれ自体で正しくとも、他の単位とかみ合わせが悪くなるということはありません。&br;処理系にバグがあれば別ですが、各式に一切の不整合のない状態でそのようなエラーが発生する処理系はおそらくまともに動作しません。&br;具体的にはソースを見ないとなんとも言えませんが、変更箇所以降に余分なダブルクォートがゴミになって残っていたのだと思われます。 --  &new{2005-08-13 18:56:32 (土)};
-Aa.3を丸写したコード部分を、１０４行以下に移行させたところ、うまくいきました。たぶん、上記のように残っていたゴミが関係していたのでだと思われます。これで解決しました。どうもありがとうございました。 -- [[Miteba]] &new{2005-08-14 11:23:10 (日)};

#comment
