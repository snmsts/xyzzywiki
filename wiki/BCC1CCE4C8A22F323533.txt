* ispellを中断したときのカーソルの位置 [#r5f58e54]
-ページ: [[質問箱]]
-投稿者: [[anonymous]]
-状態: 提案
-投稿日: 2008-11-04 (火) 15:36:53

** メッセージ [#oe435472]
ispellを"q"や"ctrl+g"で中断したとき、中断した箇所にカーソルがある状態でispellから抜け出したいのですが、どのようにしたら可能でしょうか。
ご存じの方がいらしたらお教えください。

長めの文章をスペルチェックしている際に、ispellに指摘された箇所以外に間違いや修正したいところを見つけることがよくあるので、もし上記のようなことができればいいなと思いました。

よろしくお願いいたします。

＊管理者さま
先ほどサマリを入力したところで、誤って投稿してしまいました。削除していただけますか。

----
xyzzyのlisp/ispell.l を読む限り、そのようなlispを書くしかないと思います。
ispell.lの内容をWikiにコピペしちゃってよかったか覚えてないので、以下のようにしてみたら大丈夫そうだったというのを書きます。
ispell-buffer の動作を変えてしまうので、それが気に入らなければ関数名を変えてください。

ispell.lの中身を直接変えるのはよくないので、以下の要領で、.xyzzyに書いてみて下さい。

  (in-package "editor")  ;; ediotorパッケージ
  (require "ispell")
  
  (defvar *last-ispell-point* nil) ;; 最後にispellしようとした場所
  
  ;; lisp/ispell.l から ispell-correct-word をコピペする
  (defun ispell-correct-word ()
   ;;  ....
   ;;; 以下の箇所を次のように修正する
  	    (let ((c (read-char)))
  	      (cond ((or (eql c #\q)
  			 (eql c #\C-g))
  		     (setq *last-ispell-point* (point))  ;; (1) ここに追加
  		     (quit))
  ;;  ....
  
  ;; lisp/ispell.l から ispell-region をコピペし、ispell-region2 という名前にする
  (defun ispell-region2 (beg end)
    ;;  ....
    ;; 以下の箇所を以下のように修正する
  	(setq *last-ispell-point* nil) ;; (2)ここに追加
  	(while (ispell-correct-word))
  	(setq *last-ispell-point* nil)  ;; (3)ここに追加
  	(message "Spell checking done"))
    ;;  ....
  
  ;; 以下の内容のispell-regionを作る
  (defun ispell-region (beg end)
    (interactive "r")
    (unwind-protect
        (ispell-region2 beg end)
      (when *last-ispell-point*
        (goto-char *last-ispell-point*))))
   
  (defun ispell-buffer ()
    (interactive)
    (unwind-protect                         ;; (4) ここに追加
        (ispell-region2 (point-min) (point-max))  ;; 括弧')'をひとつ削除、 ispell-region2 にする
      (when *last-ispell-point*             ;; (5) ここに追加
        (goto-char *last-ispell-point*))))  ;; (6) ここに追加
  
  (in-package "user")  ;; userパッケージに戻す

----
2008-11-13 ちょこっと修正。(3) の部分を変更。

変更前では、(message "Spell checking done") の後ろは括弧が一つになってなくてはいけないのだけど、
ispell.lのほうでは (message "Spell checking done")) と二つになっている。

ここもなおさなくてはいけなかったのだけれど、(message "Spell checking done") の部分で後ろの閉じ括弧の部分にコメントがついてなくて、
間違えやすかったので、前の行に移動して、追加するだけでよくなるようにした。

変更前
  	(setq *last-ispell-point* nil) ;; (2)ここに追加
  	(while (ispell-correct-word))
  	(message "Spell checking done")
  	(setq *last-ispell-point* nil))  ;; (3)ここに追加

変更後
  	(setq *last-ispell-point* nil) ;; (2)ここに追加
  	(while (ispell-correct-word))
  	(setq *last-ispell-point* nil)  ;; (3)ここに追加
  	(message "Spell checking done"))

----
2008-11-13 さらに修正。

以下変更点
- (4) と(5)の間で括弧を一つ削除する必要があったのを追記
- ispell-regionのことを考えていなかったので、元のispell-regionをispell-region2と変更し、 ispell-regionを別に作成

ついでに。
.xyzzyの内容が大きくなりすぎとかいう場合には、.xyzzyに直接書くよりも、
上記の内容で、 適当なファイルを作成し、site-lisp 以下に置いて require したほうが楽かもしれません。

その場合のテキトーな手順など
- fix-ispell.l とか(好きな名前でOK)いう名前のファイルを用意し、今回の修正をそのまま書く
-- その場合、最後の (in-package "user") の行はいりません。
- site-lisp 以下にファイルを置く。
- .xyzzy で (require "fix-ispell") とする。

site-lisp 以下にさらにフォルダを作成する場合は require の部分を修正してください。
site-lisp/mylisp/fix-ispell.l と置く場合は、(require "mylisp/fix-ispell") などというように。

** 動作 [#i5602713]
この変更をすると、どのような動作になる(はず)なのか書いていなかったので、書いてみました。
以下のような動作になるはずです。

例文)
  this is a pem. that is a pen.
という文章があったときに ispell-buffer すると 、「pem」の位置にカーソルがくるはずです。
そこで C-g または q とすると
  this is a pem□. that is a pen.
□の位置にカーソルがくると思います。

このような動作でよいはずと思いますがどうでしょうか？

----
- ありがとうございます。試してみます。それから改めてご報告します。 -- [[253の質問者]] &new{2008-11-10 (月) 14:28:17};
- 報告１：試してみました。まず、教えてくださったlispにispell.lの該当箇所を挿入し、「ここに追加」の行を追加し、.xyzzyにコピペしました。すると、xyzzyに「予期しない文字です:)」と言われてしまったので、指摘された行の４行前に追加した(setq *last-ispell-point* nil))の最後のパーレンを１つ削除しました。すると今度は、追加した(goto-char *last-ispell-point*))))の行について「予期しない文字です:)」と言われたので、最後のパーレンを１つ削除しました。すると無事、.xyzzyのすべてをロードしてくれました。 -- [[253の質問者]] &new{2008-11-11 (火) 12:52:43};
- 報告２：ispellをやってみました。無事動作しました。ありがとうございました。ただ、ぼくの質問の仕方が悪かったのか、教えていただいたlispだと、中断したときにカーソルが戻る位置は、ispellを開始した位置なんですね（それともぼくが報告１のようなことを勝手にやったからでしょうか）。ぼくとしては、ispellでチェックしているまさにその場所のままで、通常のエディタの状態に抜け出したかったのです。分かりにくくてすみませんでした。たとえば、1,000行のファイルに対してispellをしていて、いくつかのスペルチェックを受け入れながら500行まで来たとします。そこでispellに指摘された誤植の前後（ispellのウィンドウでは大抵、誤植の前後数行が見える）に誤植ではないけれど、修正したい箇所が見つかったとします。その場合の対処としては、２つあると思います。対処１：残りの500行についてispellでスペルチェックをしてから、500行目に戻って、先ほど発見した修正したいところを修正する。対処２：500行のところで一旦ispellを中断し、修正箇所を直して、そこから再度ispell-regionで残りの500行にスペルチェックをかける。ぼくとしては対処２ができれば便利だなと思ったので、カーソルがispellの中断した位置(上記の例で言えば500行め)にそのままあってくれたらいいなと思ったのです。修正したい箇所が１箇所のときはいいのですが、たくさんあると行数をメモっておくのが大変なので（それ以前にもっとマシな原稿を書けって言うのもあるんですが…）。すみませんが、もし可能であれば、教えていただけますか。よろしくお願いいたします。 -- [[253の質問者]] &new{2008-11-11 (火) 12:54:40};
- 変更した箇所にコメントをつけ忘れていた箇所があって、間違えやすくなってしまっていました。ごめんなさい。ispellを開始した位置に戻ってしまうのはデフォルトの動作だと思うので、変更がうまくいってないと思います。 -- [[回答してみた人]] &new{2008-11-13 (木) 01:48:54};
- 修正版と、どういう動作になるはずかも書いてみたので、こちらでもう一度確認してもらえるでしょうか？ -- [[回答してみた人]] &new{2008-11-13 (木) 01:50:31};
- 再度ありがとうございます。試してみます。それから改めてご報告します。 -- [[253の質問者]] &new{2008-11-13 (木) 11:08:25};
- 報告３：試してみました。「(6) ここに追加」の行で「予期しない文字です:)」で言われたので、今度はコメントのないところをオリジナルのispell.lと比べてみたところ、（４）と（５）の間の行の行末のパーレンも１つ削除する必要があったのですね。で、それを修正したところ、無事.xyzzyをロードしました。 -- [[253の質問者]] &new{2008-11-13 (木) 19:33:13};
- 報告４：ispellをやってみました。ispell-bufferをしてみると、まさに望んでいた動作になりました！　ありがとうございます。ところがispell-regionをしてみると、こちらはispellを開始したときのカーソルの位置に戻ってしまいました。またぼくが変なことをしたのでしょうか。でも、とりあえずispell-bufferで求めていた動作をしてくれたので、とてもありがたいです。もし、お時間があったらご確認いただけますか。 -- [[253の質問者]] &new{2008-11-13 (木) 19:34:13};
- ispellのデフォルトの動作について、ぼくが勘違いしていました。すみませんでした。いつもispell-bufferを使っていたのですが、無意識にカーソルをバッファの先頭に置いてからispell-bufferをしていたのかもしれません。それで中断後のカーソルの位置のデフォルトは「バッファの先頭」と思い込んでいたのかもしれません。 -- [[253の質問者]] &new{2008-11-13 (木) 19:37:32};
- まだコメントし忘れの部分があってすみません。ご指摘ありがとうございます。それから、ispell-regionのことをまったく考えていませんでした。修正してみましたので、ispell-region対応版になっているはずです。 -- [[回答してみた人]] &new{2008-11-13 (木) 23:53:53};
- ありがとうごさいます。試してみます。改めて報告します。 -- [[253の質問者]] &new{2008-11-14 (金) 17:29:14};
- 報告５：ispell-region対応版を試してみました。問題なく動作しました。すべてぼくが望んでいた動作になりました。本当にありがとうございました。xyzzyのlispについての基本的なことすらわからないぼくにもわかるように書いていただいて感謝しています。また、ぼくがちゃんとlispを見なかったために、二度手間になってしまって申し訳ありませんでした。 -- [[253の質問者]] &new{2008-11-17 (月) 15:19:57};
- 報告６：.xyzzyに(require "fix-ispell")だけ書いて、lisp本体は別ファイルにする方法も試しました。こちらも無事できました。ありがとうございます。当面は.xyzzyにすべて書くほうで使っていこうと思います。蛇足ですが：上記「08-11-13 さらに修正。」の「site-lisp 以下にさらにフォルダを作成する場合は」の「(require "mylisp/fix-ispell.") などというように。」の"."は不要ですよね。また、ご報告が遅れて申し訳ありませんでした。 -- [[253の質問者]] &new{2008-11-17 (月) 15:27:44};
- ご指摘感謝。直しました。>「(require "mylisp/fix-ispell.") などというように。」の"."は不要ですよね。 -- [[回答してみた人]] &new{2008-11-18 (火) 01:04:21};
- それから、こちらのケアレスミスなどで何度もテストしてもらうような形になってすみませんでした。無事、ご希望の動作になったようなのでほっとしてます。 -- [[回答してみた人]] &new{2008-11-18 (火) 01:07:29};
- 最後に。毎回丁寧に報告と御礼を書いてくださってありがとうございました。回答してみたこちらとしてもとてもうれしかったです。 -- [[回答してみた人]] &new{2008-11-18 (火) 01:10:25};
#comment
