#freeze
#contents

*Grepで一括検索 [#v1e531cf]

**遂にGrepの話 [#k234e857]

今回はGrepの話です。

Grepというのは、UNIXなどのコマンドにあるので知ってる人も多いと思います。（実はコマンドラインの奴は使ったことないけど……）それを知らない人は、Windowsにあるファイルの検索とかを想像してください。それを複雑にしたのがGrepと言って良いと思います。

このGrepは、Windowについている検索よりも便利なところがありまして((だから紹介するんだよね :p ))、幾つかのオプションを指定できます。正規表現というのを使用すれば、''ある条件に合致した部分だけでなく、ある条件に合致しない部分''までも検索することが可能です。((なんか変だと思うけれど、出来るんですよ))

また、ファイル毎に文字コードが違っていても、（ある程度の大きさのファイルなら）適切な文字コードで検索してるので、ファイル毎に文字コードが違っている状態でも検索することが出来ます。（と言っても、ファイル内に文字コードのヒントになるような文字が少ないと、文字コードの自動認識に失敗しまうこともあるみたいです。後でその例を示します）

では、本編に入る前に、いつものようにキーバインドの話をします。M-gと押してみてください。するとミニバッファに、

 Line to goto:

と表示されます。その名の通り、数字を入力すれば入力した行にキャレットが移動します。''100と入力すれば、100行目の行頭に移動できます。''数字じゃない文字とか、存在しない数字（50行しかないのに100とか）を入力すると……。（試してみてください。）メニューバーの検索（S）→指定行（J）...とだいたい同じものだと思います。

ちなみに、共通設定ダイアログの表示タブで、「行番号は表示行（D）」にチェックが入れてあり、かつ、ウィンドウ幅や指定行で折り返した表示にしていると、なんかよく分からない行に飛ぶことがあります。これはいわゆる''論理行(とか物理行とか言われるもの)''で、実際に自分がリターンキーで改行したところまでを一行として認識しているためです。

チェックを入れて、折り返し表示をしている人ならば、

 M-x goto-virtual-line

と打ってみてください。すると、飛んでいく行と行番号が一致してくれます。いつもM-gで、上記のように行の移動をして欲しい場合には、.xyzzyやsiteinit.lに

 (global-set-key #\M-g 'goto-virtual-line)

と書いておくと便利です。M-gはAlt-gという意味です。（覚えていると思うけど）siteinit.lに書いた場合には、ダンプファイルを作成しなおすのを忘れずに。((NANRIさんのご指摘に感謝！！))

**やってみる [#l7057400]

ちょっとわき道にそれました。本題に入ります。いつものようにやってみましょうか。それが一番早いだろうしね。何かテキストを用意します。例えば、

 一瞬たりとも油断するな

とか、まぁ何でもかまいません。入力し終わったら保存してください。保存する場所はデスクトップにしておきましょうか。

#br
#br

CENTER:''デスクトップに"trial.txt"というファイル名で保存''
CENTER:#ref(01.png,center,50%)
CENTER:#img(,clear)
CENTER:&size(10){デスクトップにてきとう.txtで保存};

#br
#br

そしたらxyzzyに戻ってファイルを閉じます。その後、xyzzyのメニューバーの検索→Grep（G）を選びます。すると、以下のようなダイアログが出ます。

#br
#br

CENTER:''検索→Grepで表示されるGrepダイアログ''
CENTER:#ref(02.png,center,100%)
CENTER:#img(,clear)
CENTER:&size(10){こんなのが表示されるはず。};

#br
#br

上から''パターン''、''ファイル名''、''ディレクトリ''と名前が付けられている入力欄がありますね。それぞれ、

|パターン		|検索したい文字|
|ファイル名		|検索したいファイル名（拡張子も含めて）|
|ディレクトリ		|検索したいフォルダ（前にもディレクトリの説明はしたけど）|

と言う意味です。例えば、上のファイルを指定したいならば、

|パターン		|ファイルにある文字（'''一瞬'''とか、'''たりとも'''とか）|
|ファイル名		|てきとう.txt|
|ディレクトリ		|C:/Document and Settings/tomohisa/デスクトップ/|

です。それぞれの欄に上記のように入力してみてください。実際に入力した例は、下みたいな画面になります。

#br
#br

CENTER:''実際に入力してみた''
CENTER:#ref(03.png,center,100%)
CENTER:#img(,clear)
CENTER:&size(10){上の設定の通りです。};

#br
#br

下にあるオプション設定はとりあえず気にしないで、検索ボタンを押します。すると、下みたいな画面になると思います。

#br
#br

CENTER:''検索結果の表示''
CENTER:#ref(04.png,center,50%)
CENTER:#img(,clear)
CENTER:&size(10){上みたいに表示されるはず。};

#br
#br

バッファタブを表示している人は分かると思いますが、新しく*grep*というタブが現れていると思います。これはGrepの結果を表示するバッファです。つまり、*grep*と言うところに検索して見つかった箇所が表示されます。今回の例ではもうすぐと言う所ですね。（ちなみに話は変わりますが、*scratch*とか*grep*とか*Help*とかみたいに、xyzzyが自動的に作成するファイルは保存する必要が無いので、xyzzyを終了させる時にあっても確認が行われません。それ以外で保存していないファイルがある時には、確認のダイアログが表示されます）

そうしたら、その状態でF10キーを押します。すると、下に、検索でヒットした（=マッチした、とも言います）部分が反転表示されます。

#br
#br

CENTER:''実際の文章の表示''
CENTER:#ref(05.png,center,50%)
CENTER:#img(,clear)
CENTER:&size(10){F10を押すと下に実際のところが表示されます。実際にxyzzyがファイルを開きます。タブのところに注目。};

#br
#br

**一つだけでは…… [#z9307cda]

一つだけのファイルだったら、（ファイルを開いて普通に検索すれば良いわけだから）あんまり意味がないですね。ファイルを幾つか増やしてみます。と同時に文字コードも変更してみましょう。

今度は３つくらいファイルを作ってみます。それぞれファイルに、

 ShiftJISだよー。今年の阪神は強すぎる。

 JISだよー。今年の阪神は強すぎる。

 EUCだよー。今年の阪神は強すぎる。

とか入力します。入力した後、文字コードを変更して保存します。ShiftJISと書かれたものはShitJIS（そのまま）で、以下同様にJISはJIS（ISO-2022-JP）で、EUCはEUC-JPでそれぞれ保存します。
面倒くさい人は自分が作ったものを置いておきましたので、下からダウンロードしてください。

#br
CENTER:#ref(sample.zip)
#br

そしたら、前と同じようにGrepをやって見ましょう。パターンなどはそれぞれ、

|パターン		|今年とか阪神とか（まぁ、共通してある文字なら何でも）|
|ファイル名		|*.txt|
|ディレクトリ名		|ダウンロードしたフォルダ（デスクトップ\sampleとか）|

とします。ここで注意してほしいのは、ファイル名が*.txtとなっているところです。実際に入力した画面は下の通りです。

#br
#br

CENTER:''実際の入力画面''
CENTER:#ref(06.png,center,100%)
CENTER:#img(,clear)
CENTER:&size(10){前回と少し設定を変えます。};

#br
#br

~''*''というのは、''何でもOK''と言う意味です。例えば''*.txt''なら、''拡張子がtxtのファイル全部と言う意味''、*.htmlなら同様に、拡張子がhtmlのファイル全部ってことです。ホントはもう少し説明したいのですが、これくらいにしておきます。((詳しく知りたい方はファイルマスクとかで検索してみてください。))

指定したら、前と同じように検索を押します。すると、以下のようになると思います。前と比べてヒットしたところが増えていますね。


#br
#br

CENTER:''対象ファイルが三つの時のGrepの結果''
CENTER:#ref(07.png,center,50%)
CENTER:#img(,clear)
CENTER:&size(10){文字コードが異なっていても大丈夫（ダメな時もあるので注意が必要）};

#br
#br

ヒットしたところを見るには、前回と同様にF10を押せばOKです。次にヒットした所を見るには、F11を続けて押してください。すると、次にヒットした所に飛んでいってくれます。さらに次を見るには同様にF11。さらに次は……（同じようにF11。以下ずっとF11）

ヒットしたところを見てもらえば分かるように、文字コードは適切に選んでくれます。モード行の所で少し説明したのを思い出してください。文字コードが表示されていますよね。見てみると、モード行は[sjis:crlf]とか、[jis:crlf]とか[euc-jp:crlf]になってますね。

大まかなGrepの使い方は以上です。要するに、知りたい単語等をパターンに、拡張子をファイル名に、調べるフォルダをディレクトリ名に入れれば良いわけです。特に拡張子を指定しないで検索をしたい時には、ファイル名の欄を*だけにするとそのフォルダにあるファイル全部を調べてくれます。

**オプションを設定してみる [#md5746f2]

ではその下にあるオプションを見ていきます。このオプションを指定すれば、さらに検索条件を細かく指定することが出来ます。以下の表にまとめてみました。説明を聞いてもピンとこないときには、チェックを入れて実際にGrepをしてみましょう。そうすればたぶんわかると思います。

|Grepのオプション			|説明|h
|大文字小文字を区別する（C）		|パターンに入力した大文字、小文字を区別してGrepする。日本語の時には関係ないみたい。|
|単語単位で検索する（W）		|単語((キーバインドのM-f等で進む単位をxyzzyは単語と認識しています。))のみにヒットするようになる。（[例] チェックを入れない状態で"I"を検索すると、IraqのIにも、IrelandのIにもヒットするけど、チェックを入れると、I amとかのIのように、空白文字で囲まれたもののみにヒットするようになる。）|
|正規表現（E）				|正規表現でパターンを指定できる。正規表現はこのページでは説明できないので、書籍や別のページを参照してみてください。例えばWebページでは、正規表現入門とか、[[正規表現講座:http://www.sixnine.net/regexp/]]とか、[[Sedは日暮れて:http://www.chimimo.com/sed/]]とかを見ると良いと思います。書籍では、オライリーの「[[詳説　正規表現:http://www.amazon.co.jp/exec/obidos/ASIN/4873111307/]]」と書きたいところですが、（自分みたいな人には）ちょっとつらいし、かつ値段が高いので(^^;; 「[[正規表現の達人:http://www.amazon.co.jp/exec/obidos/ASIN/4797330813/]]」とかが良いと思います。xyzzyの正規表現については[[refwiki:正規表現の表記]]参照してみてください。|
|エスケープシーケンスを理解しろ（Y）	|\tをTabに、\nを改行コード等とエスケープシーケンスとみなすようになる。このエスケープシーケンスも正規表現と一緒によく使用されますね。これについても説明できないので、別のページを参照してみてください。とりあえずTabは入力できるからいいとして、 \nが改行を示すことは覚えておいた方が良いかも……。|
|ついでにサブディレクトリも（U）	|対象フォルダ内にフォルダがある時には、その中にも潜って検索をする。C:\とかでこのチェックを入れると、いつまでたっても終わらなくなるので注意。（その時にはC-gを押せばいいんだけど）|
|非同期でgrep（A）			|Grepをかけた状態でもxyzzyの操作が行える。（チェックを入れていないと砂時計が表示されてGrepが終わるまでは操作できなくなるが、それを解除できる。）|
|ファイル名だけ出力（O）		|ファイル名だけ表示される。F10やF11は使えなくなります。あんまりチェックをすることは無いかも。|

大文字小文字や、単語単位、サブディレクトリ等をチェックすると便利です。
分かる人は、正規表現とか、エスケープシーケンスをチェックすると良いかなぁ。

**ミニバッファ版のGrepもある [#ma789c60]

今まではダイアログ版の説明をずっとしてきましたけど、ミニバッファにGrepと入力するタイプのもあります。具体的にはM-x grepと入力します。

ミニバッファから行うタイプのGrepはxyzzyで開いているファイルのみが検索対象となります。
ファイル名の指定とか、ディレクトリ名、オプションなどの設定は無いです。正規表現もつかえるみたい。

**注意点 [#n0d628d5]

Grepにはちょっとした弱点があります。それは最初に言ったように文字コードの自動認識が上手くいかなかった時です。（ま、これはGrepに限った話では無いけど……）

試しに、以下のように入力して保存してみてください。

 表示

これをEUC-JPで保存します。「ファイル」メニューから文字コードを指定して、保存してください。一度ファイルを閉じて、再び開いてみると、

 ﾉｽｼｨ

となってしまいますね。こんな時にはGrepをかけても（xyzzyが自分の思ったように文字コードを認識してくれないので）ヒットしてくれません。

そういう時にはどうすれば良いかというと、共通設定ダイアログの読み込みタブから 文字エンコーディングの判定を適当なコードに変更して下さい。そうすることで、どのファイルも特定の文字コードで開くようになるので、Grepでもヒットするようになります。例えば上記のようにEUC-JPを誤認識してしまっている場合には、''自動判定をEUC-JPに変更''しておけば良いわけです。そうすればファイルを開く時もGrepも大丈夫です。((実は、ファイルを開くには回避策があります。ファイルの先頭に開きたいエンコーディングを書いておくことで誤認識しなくなります。例えばEUC-JPなら、ファイルの先頭に-*- encoding: EUC-JP -*-と入れておくと、文字数が少ない場合にも記述した文字コードで開いてくれるようになります。))設定を変更したら、ちゃんと元に戻しておくことをお忘れなく。

**まとめ [#t2f9f1a4]

と言う訳で、大体説明できたと思います。いつものようにまとめておきます。

- Grepとは、複数のファイルに対して、ある文字を探すことを言う
- ダイアログ版とミニバッファ版の二つがある
- ダイアログ版はあるフォルダを対象に、ミニバッファ版は開いているファイル（ホントはバッファ）を対象にする
- ヒットしたところに飛ぶには、最初はF10を押す。次に飛ぶにはF11を押す。
- どちらにも正規表現の指定が行える（ダイアログ版はオプションで指定する）
- 検索の途中でやめたくなったら、C-gを押して中断する
- ダイアログ版でファイル名を指定する時には、*.txtとか*.htmlとかにする（ホントはもう少し柔軟に設定できる。例えば、.htmlと.txtを対象にしたい時には、 *.html;*.txtと;で挟んだり）
- ヒットすると思っていてヒットしない時には、文字コード設定を変更してみる

かな。まぁこんなところですね。いろいろあったな……。

**補足 [#r799039f]

Grepダイアログで、いちいちディレクトリを指定するのって、大変に感じませんか？参照ボタンを押すとディレクトリを指定するのがグラフィカルで分かりやすいですけど、深いフォルダを指定するするのは大変です。そこでちょっと細工をして、エクスプローラの「送る」から呼び出せるようにしてみましょう。

元はWikiにありましたが、どうやらなくなってしまったらしく、HIEさんのGrepの解説ページや、[[Ohkuboさんの*scratch*のページ:http://ohkubo.s53.xrea.com/xyzzy/scratch.html]]に載っています。私も便利に使わせてもらっているので、載せときます。

  (add-hook 'ed::*process-command-line-hook*
          #'(lambda (arg) (interactive)
              (when (file-directory-p arg)
                (require "grepd")
                (let ((ed::*grep-directory-name-hook*
                       #'(lambda () arg)))
                  (declare (special ed::*grep-directory-name-hook*))
                  (setq arg (map-backslash-to-slash arg))
                  (add-history arg 'ed::*grep-directory-history*)
                  (ed::grep-dialog)))))

これを、.xyzzyかsiteinit.lに書いてください。((siteinit.lに書いたなら、バイトコンパイル&ダンプファイルを作り直しましょう。))
その後、xyzzyにフォルダをもって行くと、起動しながら、Grepのダイアログが出ます。便利。

#br
#br

CENTER:''フォルダをxyzzyに送ってみると……''
CENTER:#ref(08.png,center,100%)
CENTER:#img(,clear)
CENTER:&size(10){フォルダをxyzzyに送ってみると……};

#br
#br

#br
#br

CENTER:''Grepダイアログが現れる''
CENTER:#ref(09.png,center,100%)
CENTER:#img(,clear)
CENTER:&size(10){Grepダイアログを表示してくれる。「ディレクトリ名」のパスに注目！！};

#br
#br

なかなか便利です。自分の場合はxyzzy.exeの方をショートカットにして、新しくxyzzyを起動するようにしています。

**これにて終了 [#hb44e9f9]

Grepの話はこれくらいで終わりにします。Grep風に指定をして、ヒットした箇所を置き換える次回は''Gresreg''の話です。
